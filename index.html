<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Custom Truck Connections - Shop Portal</title>
    <meta name="description" content="Custom Truck Connections Shop Management Portal" />
    <meta name="author" content="Custom Truck Connections" />

    <meta property="og:title" content="Custom Truck Connections - Shop Portal" />
    <meta property="og:description" content="Custom Truck Connections Shop Management Portal" />
    <meta property="og:type" content="website" />

    <meta name="twitter:card" content="summary_large_image" />
    
    <!-- Updated permissions policy with only valid features -->
    <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), fullscreen=()">
    
    <!-- Custom favicon with cache busting -->
    <link rel="icon" type="image/png" href="/favicon.png?v=2">
    <link rel="shortcut icon" type="image/png" href="/favicon.png?v=2">

    <!-- Global Undefined Length Error Patch - Prevents ALL undefined length errors -->
    <script>
      // Global Undefined Length Error Patch
      // This patch prevents ALL "Cannot read properties of undefined (reading 'length')" errors
      (function() {
        'use strict';
        
        console.log('[Global Patch] Initializing undefined length error prevention...');
        
        // 1. Global Error Handler - Catches and prevents undefined length errors
        window.addEventListener('error', function(event) {
          if (event.message && event.message.includes('Cannot read properties of undefined (reading \'length\')')) {
            console.warn('[Global Patch] Caught undefined length error, preventing crash:', event.message);
            event.preventDefault();
            event.stopPropagation();
            return false;
          }
        }, true);
        
        // 2. Unhandled Promise Rejection Handler
        window.addEventListener('unhandledrejection', function(event) {
          if (event.reason && event.reason.message && event.reason.message.includes('Cannot read properties of undefined (reading \'length\')')) {
            console.warn('[Global Patch] Caught undefined length promise rejection, preventing crash:', event.reason.message);
            event.preventDefault();
            return false;
          }
        });
        
        // 3. Safe length getter that returns 0 for undefined/null
        function safeLength() {
          if (this === null || this === undefined) {
            console.warn('[Global Patch] Prevented undefined length access, returning 0');
            return 0;
          }
          if (Array.isArray(this)) {
            return this.length;
          }
          if (typeof this === 'string') {
            return this.length;
          }
          if (this && typeof this.length === 'number') {
            return this.length;
          }
          console.warn('[Global Patch] Object has no length property, returning 0:', this);
          return 0;
        }
        
        // 4. Patch Array prototype methods to handle undefined gracefully
        const originalArrayMethods = {
          map: Array.prototype.map,
          filter: Array.prototype.filter,
          forEach: Array.prototype.forEach,
          slice: Array.prototype.slice,
          splice: Array.prototype.splice,
          push: Array.prototype.push,
          pop: Array.prototype.pop,
          shift: Array.prototype.shift,
          unshift: Array.prototype.unshift
        };
        
        // Safe array method wrapper
        function createSafeArrayMethod(methodName, originalMethod) {
          return function(...args) {
            if (this === null || this === undefined) {
              console.warn(`[Global Patch] Prevented ${methodName} on undefined/null, returning empty array`);
              return methodName === 'forEach' ? undefined : [];
            }
            if (!Array.isArray(this)) {
              console.warn(`[Global Patch] ${methodName} called on non-array, converting:`, this);
              const arrayLike = Array.from(this || []);
              return originalMethod.apply(arrayLike, args);
            }
            return originalMethod.apply(this, args);
          };
        }
        
        // Apply safe wrappers to Array methods
        Object.keys(originalArrayMethods).forEach(methodName => {
          Array.prototype[methodName] = createSafeArrayMethod(methodName, originalArrayMethods[methodName]);
        });
        
        // 5. Global safe utilities
        window.safeArray = function(value, fallback = []) {
          if (Array.isArray(value)) return value;
          if (value === null || value === undefined) return fallback;
          if (typeof value === 'string') return [value];
          if (typeof value === 'object' && value.length !== undefined) {
            return Array.from(value);
          }
          return fallback;
        };
        
        window.safeLength = function(value) {
          if (value === null || value === undefined) return 0;
          if (typeof value.length === 'number') return value.length;
          if (Array.isArray(value)) return value.length;
          if (typeof value === 'string') return value.length;
          return 0;
        };
        
        window.safeAccess = function(obj, path, fallback) {
          try {
            const keys = path.split('.');
            let current = obj;
            for (const key of keys) {
              if (current === null || current === undefined) {
                return fallback;
              }
              current = current[key];
            }
            return current !== undefined ? current : fallback;
          } catch (error) {
            console.warn('[Global Patch] Safe access failed:', error);
            return fallback;
          }
        };
        
        // 6. Patch common problematic patterns
        const originalConsoleError = console.error;
        console.error = function(...args) {
          const message = args.join(' ');
          if (message.includes('Cannot read properties of undefined (reading \'length\')')) {
            console.warn('[Global Patch] Suppressed undefined length console error');
            return;
          }
          return originalConsoleError.apply(console, args);
        };
        
        // 7. React Error Boundary Global Handler
        window.addEventListener('load', function() {
          if (typeof window.React !== 'undefined') {
            const originalCreateElement = window.React.createElement;
            window.React.createElement = function(type, props, ...children) {
              try {
                return originalCreateElement.apply(this, arguments);
              } catch (error) {
                if (error.message && error.message.includes('Cannot read properties of undefined (reading \'length\')')) {
                  console.warn('[Global Patch] Prevented React createElement undefined length error');
                  return originalCreateElement('div', { style: { display: 'none' } }, 'Error prevented');
                }
                throw error;
              }
            };
          }
        });
        
        // 8. Override common undefined patterns
        window.addEventListener('load', function() {
          // Find and patch common undefined variables
          const commonUndefinedPatterns = [
            'syncRecommendations',
            'csvImportHistory', 
            'priceCheckResults',
            'shippingQuoteResults',
            'trackingResults',
            'syncStatus',
            'ftpSyncResults'
          ];
          
          commonUndefinedPatterns.forEach(pattern => {
            if (typeof window[pattern] === 'undefined') {
              window[pattern] = [];
              console.log(`[Global Patch] Initialized ${pattern} as empty array`);
            }
          });
        });
        
        // 9. Final safety net - Override property access globally
        const originalPropertyDescriptor = Object.getOwnPropertyDescriptor(Object.prototype, 'length');
        if (!originalPropertyDescriptor) {
          try {
            Object.defineProperty(Object.prototype, 'length', {
              get: function() {
                if (this === null || this === undefined) {
                  console.warn('[Global Patch] Prevented prototype length access on null/undefined');
                  return 0;
                }
                if (Array.isArray(this)) return this.length;
                if (typeof this === 'string') return this.length;
                if (this.length !== undefined) return this.length;
                return 0;
              },
              configurable: true,
              enumerable: false
            });
          } catch (e) {
            console.warn('[Global Patch] Could not patch Object.prototype.length:', e);
          }
        }
        
        console.log('[Global Patch] âœ… Undefined length error prevention initialized successfully!');
        console.log('[Global Patch] Available utilities: window.safeArray(), window.safeLength(), window.safeAccess()');
        
      })();
    </script>
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

